<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>ChomGPT-1</title>
  <link rel="icon" href="/static/favicon.ico">
  <link rel="stylesheet" href="thememode.css">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body>
  <!-- Sidebar -->
  <aside id="sidebar">
    <header>
      <button id="new-chat">+ New chat</button>
      <button id="theme-toggle" title="Toggle theme">üåô</button>
    </header>
    <div id="sessions"></div>
  </aside>

  <!-- Chat -->
  <main id="chat-container"></main>

  <!-- Input -->
  <footer id="input-bar">
    <textarea id="prompt" rows="5" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á (Shift+Enter ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà)"></textarea>
    <button id="mic-btn" title="‡∏ñ‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á">üéô</button>
    <button id="send">‡∏™‡πà‡∏á</button>
    <audio id="tts-player" hidden></audio>
  </footer>

  <script>
    const chatBox   = document.getElementById('chat-container');
    const promptBox = document.getElementById('prompt');
    const sendBtn   = document.getElementById('send');
    const sessionsEl= document.getElementById('sessions');
    const newChatBtn= document.getElementById('new-chat');
    const micBtn    = document.getElementById('mic-btn');
    const ttsPlayer = document.getElementById('tts-player');

    let session_id = localStorage.getItem("session_id") || null;

    // ===== API helpers (same-origin) =====
    async function apiListSessions() {
      const r = await fetch(`/api/sessions`);
      return (await r.json()).sessions;
    }
    async function apiCreateSession(name) {
      const res = await fetch(`/api/sessions`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ session_id: name }),
      });
      if (res.status === 409) throw new Error("‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
      if (!res.ok) {
        const body = await res.json().catch(() => ({}));
        throw new Error(body.detail || "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      }
      return await res.json();
    }
    async function apiDeleteSession(id) {
      await fetch(`/api/sessions/${encodeURIComponent(id)}`, { method: "DELETE" });
    }
    async function apiGetHistory(id) {
      const r = await fetch(`/api/history?session_id=${encodeURIComponent(id)}`);
      return await r.json();
    }
    async function apiStream(prompt, id) {
      const fd = new FormData();
      fd.append("prompt", prompt);
      fd.append("session_id", id);
      const res = await fetch(`/api/chat_stream`, { method: "POST", body: fd });
      if (!res.ok || !res.body) throw new Error("stream failed");
      return res.body.getReader();
    }
    async function apiSay(text) {
      const fd = new FormData();
      fd.append("text", text);
      fd.append("lang", "th");
      return fetch(`/api/say`, { method: "POST", body: fd });
    }

    // ===== UI =====
    function renderSessions(list) {
      sessionsEl.innerHTML = "";
      if (!list.length) {
        sessionsEl.innerHTML = "<div style='padding:10px;color:#a1a1aa'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á ‡∏Å‡∏î + New chat ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á</div>";
        return;
      }
      list.forEach(item => {
        const row = document.createElement('div');
        row.className = 'session-item' + (item.session_id === session_id ? ' active' : '');
        const title = document.createElement('div');
        title.className = 'session-title';
        title.textContent = item.title;
        const del = document.createElement('button');
        del.className = 'del-btn';
        del.title = 'Delete';
        del.textContent = 'üóë';

        row.appendChild(title);
        row.appendChild(del);
        sessionsEl.appendChild(row);

        row.addEventListener('click', async (e) => {
          if (e.target === del) return;
          session_id = item.session_id;
          localStorage.setItem("session_id", session_id);
          document.querySelectorAll('.session-item').forEach(x => x.classList.remove('active'));
          row.classList.add('active');
          await loadHistoryToChat();
        });

        del.addEventListener('click', async (e) => {
          e.stopPropagation();
          if (!confirm('‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ?')) return;
          await apiDeleteSession(item.session_id);
          if (session_id === item.session_id) {
            session_id = null;
            localStorage.removeItem("session_id");
            chatBox.innerHTML = "";
          }
          await refreshSessions();
        });
      });
    }

    async function speakText(text) {
      if (!text) return;
      const res = await apiSay(text);
      if (!res.ok) return;
      const blob = await res.blob();
      const url  = URL.createObjectURL(blob);
      ttsPlayer.src = url;
      ttsPlayer.hidden = false;
      ttsPlayer.play();
    }

    // ‡πÑ‡∏°‡∏Ñ‡πå (Web Speech API)
    let rec = null;
    function startMic() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) { alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á (SpeechRecognition)"); return; }
      if (rec) return;
      rec = new SR();
      rec.lang = "th-TH";
      rec.interimResults = false;
      rec.maxAlternatives = 1;
      rec.onstart  = () => micBtn.classList.add('listening');
      rec.onend    = () => { micBtn.classList.remove('listening'); rec = null; };
      rec.onerror  = () => { micBtn.classList.remove('listening'); rec = null; };
      rec.onresult = (e) => { promptBox.value = e.results[0][0].transcript; sendPrompt(); };
      rec.start();
    }
    micBtn.onclick = startMic;

    // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ö‡∏±‡∏ö‡πÄ‡∏ö‡∏¥‡∏•
    function addMessage(role, text) {
      const wrap = document.createElement('div');
      wrap.className = `message ${role}`;
      const content = document.createElement('div');
      content.className = 'content';
      content.textContent = text;
      wrap.appendChild(content);

      if (role === 'assistant') {
        const actions = document.createElement('div');
        actions.className = 'bubble-actions';
        const speak = document.createElement('span');
        speak.className = 'speak-msg';
        speak.title = '‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ';
        speak.textContent = 'üîä ‡∏ü‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ';
        speak.onclick = () => speakText(content.textContent.trim());
        actions.appendChild(speak);
        wrap.appendChild(actions);
      }

      chatBox.appendChild(wrap);
      chatBox.scrollTop = chatBox.scrollHeight;
      return wrap;
    }

    async function refreshSessions() {
      const list = await apiListSessions();
      if (!list.length) {
        session_id = null;
        localStorage.removeItem("session_id");
        renderSessions([]);
        return;
      }
      if (!session_id) {
        session_id = list[0].session_id;
        localStorage.setItem("session_id", session_id);
      }
      renderSessions(list);
    }

    async function loadHistoryToChat() {
      if (!session_id) { chatBox.innerHTML = ""; return; }
      const data = await apiGetHistory(session_id);
      chatBox.innerHTML = "";
      for (const m of data.history) addMessage(m.role, m.content);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏™‡∏ï‡∏£‡∏µ‡∏°)
    async function sendPrompt() {
      if (!session_id) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ï ‡∏Å‡∏î + New chat ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô"); return; }
      const text = promptBox.value.trim();
      if (!text) return;
      addMessage('user', text);
      promptBox.value = '';
      const aiWrap = addMessage('assistant', '');
      const aiContent = aiWrap.querySelector('.content');

      try {
        const reader  = await apiStream(text, session_id);
        const decoder = new TextDecoder('utf-8');
        let full = "";
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, { stream: true });
          if (chunk) { full += chunk; aiContent.textContent += chunk; chatBox.scrollTop = chatBox.scrollHeight; }
        }
        window.__lastReply = full.trim();
        await refreshSessions();
      } catch {
        aiContent.textContent = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠";
      }
    }

    // Events
    sendBtn.onclick = sendPrompt;
    promptBox.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendPrompt(); }
    });
    newChatBtn.addEventListener('click', async () => {
      const name = prompt("‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ï‡πÉ‡∏´‡∏°‡πà:");
      if (!name) return;
      try {
        const created = await apiCreateSession(name);
        session_id = created.session_id;
        localStorage.setItem("session_id", session_id);
        await refreshSessions();
        await loadHistoryToChat();
      } catch (e) {
        alert(e.message || "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      }
    });

    // Init
    (async function init() {
      await refreshSessions();
      await loadHistoryToChat();
    })();

    // ===== Theme (Dark/Light) =====
    const THEME_KEY = "chat_theme";
    const themeBtn  = document.getElementById('theme-toggle');
    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem(THEME_KEY, theme);
      themeBtn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }
    function initTheme() {
      const saved = localStorage.getItem(THEME_KEY);
      if (saved === 'light' || saved === 'dark') return applyTheme(saved);
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(prefersDark ? 'dark' : 'light');
    }
    themeBtn.addEventListener('click', () => {
      const cur = document.documentElement.getAttribute('data-theme') || 'light';
      applyTheme(cur === 'light' ? 'dark' : 'light');
    });
    initTheme();
  </script>
</body>
</html>
